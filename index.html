<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€å›¾ç»„åˆæˆå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            height: 100vh;
            overflow: hidden;
            position: relative;
            color: white;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .background-text {
            position: absolute;
            font-size: 20vw;
            font-weight: 900;
            opacity: 0.05;
            z-index: -1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            user-select: none;
        }

        .container {
            display: flex;
            max-width: 1400px;
            height: 90vh;
            margin: 5vh auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .preview-area {
            flex: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .preview-canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background: #000;
        }

        .control-panel {
            flex: 2;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .panel-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .animation-selector {
            background: rgba(30, 30, 50, 0.8);
            padding: 20px;
            border-radius: 15px;
        }

        .animation-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .anim-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 15px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        }

        .anim-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.5);
        }

        .anim-btn.active {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            box-shadow: 0 0 20px rgba(255, 65, 108, 0.6);
        }

        .upload-section {
            background: rgba(30, 30, 50, 0.8);
            padding: 20px;
            border-radius: 15px;
        }

        .upload-area {
            border: 2px dashed #4a86e8;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(74, 134, 232, 0.1);
        }

        .upload-area:hover {
            background: rgba(74, 134, 232, 0.2);
        }

        .upload-icon {
            font-size: 50px;
            margin-bottom: 15px;
            color: #4a86e8;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }

        .save-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-text {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #aaa;
            min-height: 20px;
        }

        .preview-title {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 18px;
            color: #ffcc00;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }
        
        .user-image-preview {
            max-width: 100px;
            max-height: 100px;
            border: 2px solid #4a86e8;
            border-radius: 8px;
            margin: 15px auto;
            display: none;
        }
        
        .position-info {
            background: rgba(30, 30, 50, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                height: auto;
                margin: 20px;
            }
            
            .preview-area {
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
        
        /* æ–°å¢è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #00b09b, #96c93d);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="background-text">ANIMATION</div>
    
    <div class="container">
        <div class="preview-area">
            <div class="preview-title">é¢„è§ˆåŒºåŸŸ - <span id="animName">æ—‹è½¬åœ°çƒ</span></div>
            <canvas id="previewCanvas" class="preview-canvas" width="800" height="450"></canvas>
        </div>
        
        <div class="control-panel">
            <h2 class="panel-title">åŠ¨æ€å›¾ç»„åˆæˆå·¥å…·</h2>
            
            <div class="animation-selector">
                <h3>é€‰æ‹©åŠ¨ç”»æ•ˆæœ</h3>
                <div class="animation-buttons">
                    <button class="anim-btn active" data-anim="1">æ—‹è½¬åœ°çƒ</button>
                    <button class="anim-btn" data-anim="2">è·³åŠ¨å¿ƒå½¢</button>
                    <button class="anim-btn" data-anim="3">æ—‹è½¬ç«‹æ–¹ä½“</button>
                </div>
            </div>
            
            <div class="upload-section">
                <h3>ä¸Šä¼ æ‚¨çš„å›¾ç‰‡</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„</p>
                    <p class="small">æ”¯æŒ JPG, PNG æ ¼å¼å›¾ç‰‡</p>
                </div>
                <img id="userImagePreview" class="user-image-preview" alt="ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡">
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                
                <div class="position-info">
                    <p>ä½ç½®å·²é¢„è®¾ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´</p>
                    <p id="framePositionInfo">å½“å‰å¸§ä½ç½®: (400, 225) æ—‹è½¬: 0Â°</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn play-btn" id="playBtn">æ’­æ”¾åŠ¨ç”»</button>
                <button class="action-btn save-btn" id="saveBtn">ä¿å­˜ä¸ºGIF</button>
            </div>
            
            <div class="status-text" id="statusText">å‡†å¤‡å¥½åˆ›å»ºæ‚¨çš„åŠ¨ç”»ï¼</div>
            <!-- æ–°å¢è¿›åº¦æ¡ -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const config = {
            // æŒ‰é’®é…ç½®ï¼ˆå¯è½»æ¾æ·»åŠ /åˆ é™¤/ä¿®æ”¹ï¼‰
            buttons: [
                { id: "1", text: "æ—‹è½¬åœ°çƒ" },
                { id: "2", text: "è·³åŠ¨å¿ƒå½¢" },
                { id: "3", text: "æ—‹è½¬ç«‹æ–¹ä½“" }
            ],
            
            // åŠ¨ç”»å¸§é…ç½®
            animations: {
                "1": {
                    name: "æ—‹è½¬åœ°çƒ",
                    frameCount: 2,
                    frameImages: [],
                    frameURLs: [
                        'image1/frame0.png',
                        'image1/frame1.png'
                    ],
                    // æ¯å¸§çš„å åŠ ä½ç½®å’Œæ—‹è½¬å‚æ•°
                    overlayPositions: [
                        { x: 400, y: 225, rotation: 0, scale: 4 },
                        { x: 410, y: 230, rotation: 15, scale: 4 }
                    ]
                },
                "2": {
                    name: "è·³åŠ¨å¿ƒå½¢",
                    frameCount: 2,
                    frameImages: [],
                    frameURLs: [
                        "https://via.placeholder.com/800x450/ff0000/ffffff?text=å¿ƒå½¢å¸§1",
                        "https://via.placeholder.com/800x450/ff3333/ffffff?text=å¿ƒå½¢å¸§18"
                    ],
                    overlayPositions: [
                        { x: 400, y: 200, rotation: 0, scale: 0.4 },
                        { x: 400, y: 225, rotation: 0, scale: 0.46 }
                    ]
                },
                "3": {
                    name: "æ—‹è½¬ç«‹æ–¹ä½“",
                    frameCount: 2,
                    frameImages: [],
                    frameURLs: [
                        "https://via.placeholder.com/800x450/6a11cb/ffffff?text=ç«‹æ–¹ä½“å¸§1",
                        "https://via.placeholder.com/800x450/6a00cc/ffffff?text=ç«‹æ–¹ä½“å¸§30"
                    ],
                    overlayPositions: [
                        { x: 400, y: 225, rotation: 0, scale: 0.6 },
                        { x: 350, y: 225, rotation: 348, scale: 0.6 }
                    ]
                }
            }
        };

        // DOM å…ƒç´ 
        const dom = {
            canvas: document.getElementById('previewCanvas'),
            ctx: document.getElementById('previewCanvas').getContext('2d'),
            uploadArea: document.getElementById('uploadArea'),
            imageUpload: document.getElementById('imageUpload'),
            userImagePreview: document.getElementById('userImagePreview'),
            playBtn: document.getElementById('playBtn'),
            saveBtn: document.getElementById('saveBtn'),
            statusText: document.getElementById('statusText'),
            animName: document.getElementById('animName'),
            framePositionInfo: document.getElementById('framePositionInfo'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar')
        };

        // åº”ç”¨çŠ¶æ€
        const state = {
            currentAnimation: '1',
            userImage: null,
            isPlaying: false,
            currentFrame: 0,
            frameInterval: null,
            composedFrames: {}
        };

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            setupButtons();
            setupEventListeners();
            preloadFrameImages();
            renderFrame(0);
        }

        // é¢„åŠ è½½å¸§å›¾ç‰‡ - ä¿®æ”¹åçš„å‡½æ•°
        function preloadFrameImages() {
            Object.keys(config.animations).forEach(animId => {
                const anim = config.animations[animId];
                anim.frameImages = []; // æ¸…ç©ºæ•°ç»„
                
                // åŠ è½½çœŸå®å›¾ç‰‡
                for (let i = 0; i < anim.frameCount; i++) {
                    const img = new Image();
                    //img.crossOrigin = "Anonymous"; // å…è®¸è·¨åŸŸå›¾ç‰‡
                    
                    // ä½¿ç”¨æ‚¨çš„æœ¬åœ°è·¯å¾„
                    img.src = anim.frameURLs[i];
                    
                    img.onload = () => {
                        dom.statusText.textContent = `åŠ è½½ä¸­: ${anim.name} (${i+1}/${anim.frameCount})`;
                        
                        // å…¨éƒ¨åŠ è½½å®Œæˆåæ›´æ–°çŠ¶æ€
                        if (i === anim.frameCount - 1) {
                            dom.statusText.textContent = `${anim.name} åŠ è½½å®Œæˆ`;
                        }
                    };
                    
                    img.onerror = () => {
                        console.error(`æ— æ³•åŠ è½½å›¾ç‰‡: ${anim.frameURLs[i]}`);
                        dom.statusText.textContent = `é”™è¯¯: æ— æ³•åŠ è½½å›¾ç‰‡ ${i+1}`;
                    };
                    
                    anim.frameImages.push(img);
                }
            });
        }

        // è®¾ç½®åŠ¨ç”»é€‰æ‹©æŒ‰é’®
        function setupButtons() {
            const container = document.querySelector('.animation-buttons');
            container.innerHTML = '';
            
            config.buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `anim-btn ${btn.id === state.currentAnimation ? 'active' : ''}`;
                button.dataset.anim = btn.id;
                button.textContent = btn.text;
                button.addEventListener('click', () => {
                    document.querySelector('.anim-btn.active').classList.remove('active');
                    button.classList.add('active');
                    changeAnimation(btn.id);
                });
                container.appendChild(button);
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            dom.uploadArea.addEventListener('click', () => dom.imageUpload.click());
            
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            dom.imageUpload.addEventListener('change', handleImageUpload);
            
            // æ’­æ”¾æŒ‰é’®äº‹ä»¶
            dom.playBtn.addEventListener('click', toggleAnimation);
            
            // ä¿å­˜æŒ‰é’®äº‹ä»¶
            dom.saveBtn.addEventListener('click', saveAsGif);
            
            // å…è®¸æ‹–æ”¾ä¸Šä¼ 
            dom.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dom.uploadArea.style.background = 'rgba(74, 134, 232, 0.3)';
            });
            
            dom.uploadArea.addEventListener('dragleave', () => {
                dom.uploadArea.style.background = 'rgba(74, 134, 232, 0.1)';
            });
            
            dom.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dom.uploadArea.style.background = 'rgba(74, 134, 232, 0.1)';
                
                if (e.dataTransfer.files.length) {
                    dom.imageUpload.files = e.dataTransfer.files;
                    handleImageUpload();
                }
            });
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload() {
            const file = dom.imageUpload.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                dom.statusText.textContent = 'è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ (JPG, PNG)';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.userImage = new Image();
                state.userImage.src = e.target.result;
                state.userImage.onload = () => {
                    dom.statusText.textContent = 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ!';
                    dom.userImagePreview.src = state.userImage.src;
                    dom.userImagePreview.style.display = 'block';
                    
                    // æ¸…é™¤ç¼“å­˜
                    state.composedFrames = {};
                    
                    // æ›´æ–°æ˜¾ç¤º
                    renderFrame(state.currentFrame);
                };
            };
            reader.readAsDataURL(file);
        }

        // æ›´æ”¹å½“å‰åŠ¨ç”»
        function changeAnimation(animId) {
            stopAnimation();
            state.currentAnimation = animId;
            state.currentFrame = 0;
            dom.animName.textContent = config.animations[animId].name;
            renderFrame(0);
            dom.statusText.textContent = `å·²é€‰æ‹©: ${config.animations[animId].name}`;
        }

        // æ¸²æŸ“æŒ‡å®šå¸§ - ä¿®æ”¹åçš„å‡½æ•°
        function renderFrame(frameIndex) {
            const anim = config.animations[state.currentAnimation];
            const canvas = dom.canvas;
            const ctx = dom.ctx;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯å¸§ - ä½¿ç”¨çœŸå®å›¾ç‰‡
            if (anim.frameImages[frameIndex] && anim.frameImages[frameIndex].complete) {
                ctx.drawImage(anim.frameImages[frameIndex], 0, 0, canvas.width, canvas.height);
            } else {
                // å¦‚æœå›¾ç‰‡æœªåŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºå ä½èƒŒæ™¯
                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`åŠ è½½ä¸­: ${anim.name} å¸§ ${frameIndex+1}`, canvas.width/2, canvas.height/2);
            }
            
            // å¦‚æœç”¨æˆ·ä¸Šä¼ äº†å›¾ç‰‡ï¼Œåˆ™ç»˜åˆ¶
            if (state.userImage) {
                const pos = anim.overlayPositions[frameIndex];
                const imgWidth = state.userImage.width * pos.scale;
                const imgHeight = state.userImage.height * pos.scale;
                
                ctx.save();
                ctx.translate(pos.x, pos.y);
                ctx.rotate(pos.rotation * Math.PI / 180);
                
                // ç»˜åˆ¶ç”¨æˆ·å›¾ç‰‡
                ctx.drawImage(
                    state.userImage, 
                    -imgWidth/2, 
                    -imgHeight/2,
                    imgWidth,
                    imgHeight
                );
                
                ctx.restore();
                
                // æ›´æ–°ä½ç½®ä¿¡æ¯
                dom.framePositionInfo.textContent = 
                    `å½“å‰å¸§ä½ç½®: (${pos.x}, ${pos.y}) æ—‹è½¬: ${pos.rotation}Â°`;
            }
        }

        // åˆ‡æ¢åŠ¨ç”»æ’­æ”¾çŠ¶æ€
        function toggleAnimation() {
            if (state.isPlaying) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        // å¼€å§‹æ’­æ”¾åŠ¨ç”»
        function startAnimation() {
            if (!state.userImage) {
                dom.statusText.textContent = 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼';
                return;
            }
            
            const anim = config.animations[state.currentAnimation];
            state.isPlaying = true;
            dom.playBtn.textContent = 'åœæ­¢æ’­æ”¾';
            dom.playBtn.style.background = 'linear-gradient(to right, #ff416c, #ff4b2b)';
            
            state.frameInterval = setInterval(() => {
                state.currentFrame = (state.currentFrame + 1) % anim.frameCount;
                renderFrame(state.currentFrame);
            }, 100);
        }

        // åœæ­¢æ’­æ”¾åŠ¨ç”»
        function stopAnimation() {
            if (state.frameInterval) {
                clearInterval(state.frameInterval);
            }
            state.isPlaying = false;
            dom.playBtn.textContent = 'æ’­æ”¾åŠ¨ç”»';
            dom.playBtn.style.background = 'linear-gradient(to right, #00b09b, #96c93d)';
        }

        // ä¿å­˜ä¸ºGIF - ä¿®å¤åçš„å‡½æ•°
        function saveAsGif() {
            if (!state.userImage) {
                dom.statusText.textContent = 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼';
                return;
            }
            
            dom.statusText.textContent = 'æ­£åœ¨ç”ŸæˆGIF...';
            dom.saveBtn.disabled = true;
            dom.progressContainer.style.display = 'block';
            dom.progressBar.style.width = '0%';
            
            const anim = config.animations[state.currentAnimation];
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: dom.canvas.width,
                height: dom.canvas.height
            });
            
            // åˆ›å»ºç¦»å±canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = dom.canvas.width;
            tempCanvas.height = dom.canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // æ·»åŠ æ¯ä¸€å¸§åˆ°GIF
            for (let i = 0; i < anim.frameCount; i++) {
                // ç»˜åˆ¶èƒŒæ™¯å¸§
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(anim.frameImages[i], 0, 0);
                
                // ç»˜åˆ¶ç”¨æˆ·å›¾ç‰‡ï¼ˆä½¿ç”¨é¢„è®¾ä½ç½®ï¼‰
                const pos = anim.overlayPositions[i];
                const imgWidth = state.userImage.width * pos.scale;
                const imgHeight = state.userImage.height * pos.scale;
                
                tempCtx.save();
                tempCtx.translate(pos.x, pos.y);
                tempCtx.rotate(pos.rotation * Math.PI / 180);
                tempCtx.drawImage(
                    state.userImage, 
                    -imgWidth/2, 
                    -imgHeight/2,
                    imgWidth,
                    imgHeight
                );
                tempCtx.restore();
                
                // æ·»åŠ åˆ°GIF (ä¿®å¤ç‚¹ï¼šä¼ é€’canvaså…ƒç´ è€Œä¸æ˜¯ä¸Šä¸‹æ–‡)
                gif.addFrame(tempCanvas, { delay: 100, copy: true });
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = ((i + 1) / anim.frameCount) * 100;
                dom.progressBar.style.width = `${progress}%`;
            }
            
            // ç”ŸæˆGIF
            gif.on('finished', function(blob) {
                saveAs(blob, 'animation.gif');
                dom.statusText.textContent = 'GIFä¿å­˜æˆåŠŸï¼';
                dom.saveBtn.disabled = false;
                dom.progressContainer.style.display = 'none';
            });
            
            gif.on('progress', function(p) {
                // è¿›åº¦äº‹ä»¶å¤„ç†ï¼ˆå¦‚æœéœ€è¦æ›´ç²¾ç¡®çš„è¿›åº¦ï¼‰
            });
            
            gif.on('abort', function() {
                dom.statusText.textContent = 'GIFç”Ÿæˆå·²ä¸­æ­¢';
                dom.saveBtn.disabled = false;
                dom.progressContainer.style.display = 'none';
            });
            
            gif.render();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>